#!/bin/bash

FECHA=$(date '+%Y-%m-%d %H:%M:%S')
LOG="/home/pi/logs/mantenimiento_integrado.log"
EMAIL="verdugoper@gmail.com"

echo "$FECHA üîç Verificaci√≥n post-reinicio iniciada." | tee -a "$LOG"

# Contenedores reales seg√∫n Portainer
CONTENEDORES=("adguardhome" "docker-controller-bot" "duckdns" "netdata" "plex" "portainer" "wg-easy")

# Esperar a que Docker est√© operativo
until docker info >/dev/null 2>&1; do
    echo "$FECHA ‚è≥ Esperando que Docker est√© listo..." | tee -a "$LOG"
    sleep 5
done

# Esperar a que los contenedores aparezcan
for NAME in "${CONTENEDORES[@]}"; do
    until docker ps --format "{{.Names}}" | grep -qi "$NAME"; do
        echo "$FECHA ‚è≥ Esperando que '$NAME' aparezca en docker ps..." | tee -a "$LOG"
        sleep 5
    done
done

# Verificaci√≥n final
for NAME in "${CONTENEDORES[@]}"; do
    ESTADO=$(docker inspect -f '{{.State.Status}}' "$NAME" 2>/dev/null)
    SALUD=$(docker inspect -f '{{.State.Health.Status}}' "$NAME" 2>/dev/null)

    if [ "$ESTADO" = "running" ]; then
        if [ "$SALUD" = "healthy" ] || [ -z "$SALUD" ]; then
            echo "$FECHA ‚úÖ '$NAME' funcionando correctamente." | tee -a "$LOG"
        else
            echo "$FECHA ‚ö†Ô∏è '$NAME' corriendo pero no saludable: $SALUD" | tee -a "$LOG"
        fi
    else
        echo "$FECHA ‚ùå '$NAME' NO est√° funcionando. Estado: $ESTADO" | tee -a "$LOG"
    fi
done

# Env√≠o de correo
ASUNTO="[$FECHA] üß© Verificaci√≥n post-reinicio Raspberry Pi"
MENSAJE="Resumen:\n\n$(tail -n 40 "$LOG")"

echo -e "Subject: $ASUNTO\n\n$MENSAJE" | msmtp "$EMAIL"
echo "$FECHA üìß Correo enviado." | tee -a "$LOG"