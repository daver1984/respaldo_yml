1) mantencion
Ruta recomendada: /usr/local/bin/mantencion
Permisos: sudo chmod +x /usr/local/bin/mantencion

#!/bin/bash

FECHA=$(date '+%Y-%m-%d %H:%M:%S')
LOG="/home/pi/logs/mantenimiento_integrado.log"
EMAIL="verdugoper@gmail.com"

echo "$FECHA üßπ Iniciando mantenci√≥n semanal..." | tee -a "$LOG"

# Actualizaci√≥n del sistema operativo
echo "$FECHA üì¶ Actualizando sistema operativo..." | tee -a "$LOG"
sudo apt update && sudo apt full-upgrade -y | tee -a "$LOG"

# Actualizaci√≥n de contenedores Docker
echo "$FECHA üê≥ Actualizando contenedores Docker..." | tee -a "$LOG"
docker pull lscr.io/linuxserver/plex:latest
docker pull lscr.io/linuxserver/duckdns:latest
docker pull portainer/portainer-ce:latest
docker pull netdata/netdata:stable
docker pull dgongut/docker-controller-bot:latest
docker pull adguard/adguardhome:latest
docker pull ghcr.io/wg-easy/wg-easy:latest

# Recreaci√≥n de contenedores mediante Portainer (stacks)
echo "$FECHA üîÑ Recreando stacks..." | tee -a "$LOG"
docker compose -f /home/pi/docker/plex/docker-compose.yml pull && docker compose -f /home/pi/docker/plex/docker-compose.yml up -d
docker compose -f /home/pi/docker/duckdns/docker-compose.yml pull && docker compose -f /home/pi/docker/duckdns/docker-compose.yml up -d
docker compose -f /home/pi/docker/portainer/docker-compose.yml pull && docker compose -f /home/pi/docker/portainer/docker-compose.yml up -d
docker compose -f /home/pi/docker/netdata/docker-compose.yml pull && docker compose -f /home/pi/docker/netdata/docker-compose.yml up -d
docker compose -f /home/pi/docker/bot/docker-compose.yml pull && docker compose -f /home/pi/docker/bot/docker-compose.yml up -d
docker compose -f /home/pi/docker/wire-adguard/docker-compose.yml pull && docker compose -f /home/pi/docker/wire-adguard/docker-compose.yml up -d

# Limpieza de im√°genes antiguas
echo "$FECHA üßπ Eliminando im√°genes antiguas..." | tee -a "$LOG"
docker image prune -af | tee -a "$LOG"

# Reinicio del sistema
echo "$FECHA üîÑ Reiniciando Raspberry Pi..." | tee -a "$LOG"
sudo reboot



2) verificacion_post_reboot
Ruta recomendada: /usr/local/bin/verificacion_post_reboot
Permisos: sudo chmod +x /usr/local/bin/verificacion_post_reboot

#!/bin/bash

FECHA=$(date '+%Y-%m-%d %H:%M:%S')
LOG="/home/pi/logs/mantenimiento_integrado.log"
EMAIL="verdugoper@gmail.com"

echo "$FECHA üîç Verificaci√≥n post-reinicio iniciada." | tee -a "$LOG"

# Contenedores reales seg√∫n Portainer
CONTENEDORES=("adguardhome" "docker-controller-bot" "duckdns" "netdata" "plex" "portainer" "wg-easy")

# Esperar a que Docker est√© operativo
until docker info >/dev/null 2>&1; do
    echo "$FECHA ‚è≥ Esperando que Docker est√© listo..." | tee -a "$LOG"
    sleep 5
done

# Esperar a que los contenedores aparezcan
for NAME in "${CONTENEDORES[@]}"; do
    until docker ps --format "{{.Names}}" | grep -qi "$NAME"; do
        echo "$FECHA ‚è≥ Esperando que '$NAME' aparezca en docker ps..." | tee -a "$LOG"
        sleep 5
    done
done

# Verificaci√≥n final
for NAME in "${CONTENEDORES[@]}"; do
    ESTADO=$(docker inspect -f '{{.State.Status}}' "$NAME" 2>/dev/null)
    SALUD=$(docker inspect -f '{{.State.Health.Status}}' "$NAME" 2>/dev/null)

    if [ "$ESTADO" = "running" ]; then
        if [ "$SALUD" = "healthy" ] || [ -z "$SALUD" ]; then
            echo "$FECHA ‚úÖ '$NAME' funcionando correctamente." | tee -a "$LOG"
        else
            echo "$FECHA ‚ö†Ô∏è '$NAME' corriendo pero no saludable: $SALUD" | tee -a "$LOG"
        fi
    else
        echo "$FECHA ‚ùå '$NAME' NO est√° funcionando. Estado: $ESTADO" | tee -a "$LOG"
    fi
done

# Env√≠o de correo
ASUNTO="[$FECHA] üß© Verificaci√≥n post-reinicio Raspberry Pi"
MENSAJE="Resumen:\n\n$(tail -n 40 "$LOG")"

echo -e "Subject: $ASUNTO\n\n$MENSAJE" | msmtp "$EMAIL"
echo "$FECHA üìß Correo enviado." | tee -a "$LOG"


3) Servicio systemd
Archivo: /etc/systemd/system/verificacion.service

[Unit]
Description=Verificaci√≥n post reinicio
After=multi-user.target docker.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/verificacion_post_reboot

[Install]
WantedBy=multi-user.target
